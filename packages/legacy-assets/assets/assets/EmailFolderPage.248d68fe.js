import{f as W,aG as ee,aH as te,j as D,x as _,h as z,q as b,O as ae,N as se,t as le,s as ie,a1 as oe,k as re,v as ne,z as A,aI as H,U as ce,n as ue,_ as de,a as fe,o as v,c as x,w as n,F as u,e as m,W as V,aD as k,G as M,H as w,J as me,Q as C,I as T,aa as U}from"./index.7b40bbd4.js";import{Q as S}from"./QTd.4cf72ee9.js";import{h as he}from"./QTable.1e443668.js";import{s as ve,d as N,a as $,e as q,g as ge}from"./scroll.729e661d.js";import{Q as pe}from"./QPage.07d38c58.js";import{api as be}from"./axios.c4f749e1.js";import{u as we}from"./main-store.718cb995.js";import{w as R,e as Q,x as ye}from"./QSeparator.83243ffb.js";import"./use-dark.5b3707da.js";import"./use-checkbox.8a12221a.js";import"./focus-manager.1ddae684.js";import"./use-transition.d5ce3370.js";const _e='<circle cx="15" cy="15" r="15"><animate attributeName="r" from="15" to="15" begin="0s" dur="0.8s" values="15;9;15" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" from="1" to="1" begin="0s" dur="0.8s" values="1;.5;1" calcMode="linear" repeatCount="indefinite"></animate></circle><circle cx="60" cy="15" r="9" fill-opacity=".3"><animate attributeName="r" from="9" to="9" begin="0s" dur="0.8s" values="9;15;9" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" from=".5" to=".5" begin="0s" dur="0.8s" values=".5;1;.5" calcMode="linear" repeatCount="indefinite"></animate></circle><circle cx="105" cy="15" r="15"><animate attributeName="r" from="15" to="15" begin="0s" dur="0.8s" values="15;9;15" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" from="1" to="1" begin="0s" dur="0.8s" values="1;.5;1" calcMode="linear" repeatCount="indefinite"></animate></circle>';var xe=W({name:"QSpinnerDots",props:ee,setup(e){const{cSize:l,classes:r}=te(e);return()=>D("svg",{class:r.value,fill:"currentColor",width:l.value,height:l.value,viewBox:"0 0 120 30",xmlns:"http://www.w3.org/2000/svg",innerHTML:_e})}});const{passive:h}=ne;var ke=W({name:"QInfiniteScroll",props:{offset:{type:Number,default:500},debounce:{type:[String,Number],default:100},scrollTarget:ve,initialIndex:{type:Number,default:0},disable:Boolean,reverse:Boolean},emits:["load"],setup(e,{slots:l,emit:r}){const t=_(!1),a=_(!0),d=_(null),i=_(null);let y=e.initialIndex,s,c;const G=z(()=>"q-infinite-scroll__loading"+(t.value===!0?"":" invisible"));function g(){if(e.disable===!0||t.value===!0||a.value===!1)return;const o=N(s),f=$(s),p=H(s);e.reverse===!1?Math.round(f+p+e.offset)>=Math.round(o)&&I():Math.round(f)<=e.offset&&I()}function I(){if(e.disable===!0||t.value===!0||a.value===!1)return;y++,t.value=!0;const o=N(s);r("load",y,f=>{a.value===!0&&(t.value=!1,A(()=>{if(e.reverse===!0){const p=N(s),Y=$(s),Z=p-o;q(s,Y+Z)}f===!0?P():d.value&&d.value.closest("body")&&c()}))})}function J(){y=0}function L(){a.value===!1&&(a.value=!0,s.addEventListener("scroll",c,h)),g()}function P(){a.value===!0&&(a.value=!1,t.value=!1,s.removeEventListener("scroll",c,h),c!==void 0&&c.cancel!==void 0&&c.cancel())}function B(){if(s&&a.value===!0&&s.removeEventListener("scroll",c,h),s=ge(d.value,e.scrollTarget),a.value===!0){if(s.addEventListener("scroll",c,h),e.reverse===!0){const o=N(s),f=H(s);q(s,o-f)}g()}}function K(o){y=o}function O(o){o=parseInt(o,10);const f=c;c=o<=0?g:ce(g,isNaN(o)===!0?100:o),s&&a.value===!0&&(f!==void 0&&s.removeEventListener("scroll",f,h),s.addEventListener("scroll",c,h))}function j(o){if(F.value===!0){if(i.value===null){o!==!0&&A(()=>{j(!0)});return}const f=`${t.value===!0?"un":""}pauseAnimations`;Array.from(i.value.getElementsByTagName("svg")).forEach(p=>{p[f]()})}}const F=z(()=>e.disable!==!0&&a.value===!0);b([t,F],()=>{j()}),b(()=>e.disable,o=>{o===!0?P():L()}),b(()=>e.reverse,()=>{t.value===!1&&a.value===!0&&g()}),b(()=>e.scrollTarget,B),b(()=>e.debounce,O);let E=!1;ae(()=>{E!==!1&&s&&q(s,E)}),se(()=>{E=s?$(s):!1}),le(()=>{a.value===!0&&s.removeEventListener("scroll",c,h)}),ie(()=>{O(e.debounce),B(),t.value===!1&&j()});const X=ue();return Object.assign(X.proxy,{poll:()=>{c!==void 0&&c()},trigger:I,stop:P,reset:J,resume:L,setIndex:K,updateScrollTarget:B}),()=>{const o=oe(l.default,[]);return F.value===!0&&o[e.reverse===!1?"push":"unshift"](D("div",{ref:i,class:G.value},re(l.loading))),D("div",{class:"q-infinite-scroll",ref:d},o)}}});const Me=fe({name:"EmailFolderPage",data:()=>({timeInterval:null,indexCursors:null,loading:!1,loadMoreAutomatically:!0,hasMorePages:!0,rows:[],columns:[{name:"sender",required:!0,field:"sender",align:"left",sortable:!1},{name:"subject",required:!0,field:"subject",align:"left",sortable:!1},{name:"lastModified",required:!0,align:"left",field:"lastModified",sortable:!1},{name:"has_attachments",required:!0,align:"left",field:"has_attachments",sortable:!1}]}),computed:{selectedBucket:function(){return this.$route.params.bucket},selectedFolder:()=>"inbox"},watch:{selectedBucket(e){this.fetchFiles()}},methods:{rowClass:e=>e.row.customMetadata.read==="true"?"email-read":"email-unread",rowClick:function(e,l,r){const t=l.key.replace(/^.*[\\/]/,"");this.$router.push({name:"email-file",params:{bucket:this.selectedBucket,folder:this.selectedFolder,file:R(t)}})},createOrUpdateIndex:async function(e){let l=!0,r=null,t=0,a={version:1,cursors:[]};if(e&&(a=e,e.cursors.length>0)){const d=e.cursors.pop();t=d.page,r=d.cursor}for(;l;){console.log(`Updating index page ${t}`);const d=await be.get(`/buckets/${this.selectedBucket}?include=customMetadata&include=httpMetadata`,{params:{delimiter:"/",prefix:R(`.r2-explorer/emails/${this.selectedFolder}/`),cursor:r}});a.cursors.push({page:t,cursor:r,items:d.data.objects.length}),r=d.data.cursor,l=d.data.truncated,t++}return a},getOrCreateIndex:async function(){const e=`.r2-explorer/emails/index-${this.selectedFolder}.json`,l=await Q.downloadFile(this.selectedBucket,e,{}).then(a=>a.data).catch(a=>null),r=await this.createOrUpdateIndex(l),t=new Blob([JSON.stringify(r)],{type:"application/json"});try{await Q.uploadObjects(t,e,this.selectedBucket)}catch{}return r},loadNextPage:async function(e,l){const r=this.indexCursors[e];r?await this.loadIndexPage(r):(this.loadMoreAutomatically=!0,this.hasMorePages=!1),l()},fetchFiles:async function(){this.loading=!0,this.rows=[];const e=await this.getOrCreateIndex();this.indexCursors=e.cursors.reverse(),await this.loadNextPage(0,()=>{}),await this.$refs.infScroll.setIndex(0),await this.$refs.infScroll.poll(),this.loadMoreAutomatically=!1,this.loading=!1},loadIndexPage:async function(e){const l=await Q.listObjects(this.selectedBucket,`.r2-explorer/emails/${this.selectedFolder}/`,"/",e.cursor);if(l.data.objects){const r=l.data.objects.filter(t=>!t.key.endsWith("/")).map(t=>{const a=new Date(Number.parseInt(t.customMetadata.timestamp));return{...t,sender:t.customMetadata.from_name||t.customMetadata.from_address,subject:t.customMetadata.subject,has_attachments:t.customMetadata.has_attachments==="true",read:t.customMetadata.read,lastModified:ye(a),timestamp:Number.parseInt(t.customMetadata.timestamp)}});for(const t of r.reverse())this.rows.push(t)}}},unmounted(){clearInterval(this.timeInterval),this.timeInterval=null},mounted(){this.timeInterval=setInterval(()=>{this.fetchFiles()},3e5)},created(){this.fetchFiles()},setup(){return{mainStore:we()}}}),Ce={class:""},Se={class:"full-width q-my-lg"},Ne={class:"flex items-center justify-center"},Ie={class:"q-mb-md"},Pe={class:"text-left"},Be={class:"flex column"},je={class:"flex"},Fe={class:"mobile-title"},Ee={class:"mobile-last-modified mobile-subject"},Te={class:"email-subject mobile-subject"},$e={key:0,class:"full-width q-my-lg"},qe={class:"flex items-center justify-center"},Qe={key:0,class:"row justify-center q-my-md"},De={class:"row justify-center q-my-md"};function Le(e,l,r,t,a,d){return v(),x(pe,{class:""},{default:n(()=>[u("div",Ce,[m(ke,{ref:"infScroll",disable:e.loadMoreAutomatically,onLoad:e.loadNextPage,offset:250,debounce:100},{loading:n(()=>[u("div",De,[m(xe,{color:"primary",size:"40px"})])]),default:n(()=>[m(he,{ref:"table",rows:e.rows,columns:e.columns,"row-key":"name",loading:e.loading,"hide-pagination":!0,"rows-per-page-options":[0],flat:!0,"table-class":"email-list",onRowClick:e.rowClick},{loading:n(()=>[u("div",Se,[u("h6",Ne,[m(V,{color:"primary",size:"xl"})])])]),"body-cell":n(i=>[m(S,{props:i,class:k(e.rowClass(i))},{default:n(()=>[M(w(i.value),1)]),_:2},1032,["props","class"])]),header:n(()=>[u("tr",Ie,[u("th",Pe,[m(me,{color:"green",icon:"refresh",loading:e.loading,onClick:e.fetchFiles},{loading:n(()=>[m(V,{color:"white"})]),_:1},8,["loading","onClick"])])])]),"body-cell-sender":n(i=>[m(S,{props:i,class:k(["email-sender",e.rowClass(i)])},{default:n(()=>[u("div",Be,[u("div",je,[u("div",Fe,w(i.value),1),u("div",Ee,[M(w(i.row.lastModified)+" ",1),i.row.has_attachments?(v(),x(C,{key:0,name:"attachment",size:"sm",color:"black"})):T("",!0)])]),u("div",Te,w(i.row.subject),1)])]),_:2},1032,["props","class"])]),"body-cell-subject":n(i=>[m(S,{props:i,class:k(["email-subject",e.rowClass(i)])},{default:n(()=>[M(w(i.value),1)]),_:2},1032,["props","class"])]),"no-data":n(()=>[e.loading?T("",!0):(v(),U("div",$e,[u("h6",qe,[m(C,{name:"alternate_email",color:"orange",size:"lg"}),l[0]||(l[0]=M(" This bucket doesn't have Emails "))])]))]),"body-cell-has_attachments":n(i=>[m(S,{props:i,class:k(e.rowClass(i))},{default:n(()=>[i.row.has_attachments?(v(),x(C,{key:0,name:"attachment",size:"sm",color:"black"})):(v(),x(C,{key:1,size:"sm",color:"white"}))]),_:2},1032,["props","class"])]),_:1},8,["rows","columns","loading","onRowClick"]),e.hasMorePages?T("",!0):(v(),U("div",Qe,l[1]||(l[1]=[u("span",null,"No more emails to load",-1)])))]),_:1},8,["disable","onLoad"])])]),_:1})}var Ye=de(Me,[["render",Le]]);export{Ye as default};
